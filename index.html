<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ¬åœ°å…¨æ ¼å¼è½¬æ¢å·¥å…·ï¼ˆç¨³å®šç‰ˆï¼‰</title>
  <!-- Tailwind CSS (å§‹ç»ˆå¯ç”¨) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- åˆå§‹ä¾èµ–åº“é™æ€åŠ è½½ï¼ˆå°è¯•å¿«é€ŸåŠ è½½ï¼Œå¤±è´¥ååŠ¨æ€é‡è¯•ï¼‰ -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    /* åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .lib-status-item { display: flex; align-items: center; margin-bottom: 4px; }
    .lib-status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .lib-status-dot.success { background-color: #10b981; }
    .lib-status-dot.failed { background-color: #ef4444; }
    .lib-status-dot.loading { background-color: #f59e0b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900">æœ¬åœ°å…¨æ ¼å¼è½¬æ¢å·¥å…·</h1>
        <p class="text-green-600 text-sm font-medium">âœ… æ‰€æœ‰æ–‡ä»¶å‡åœ¨æœ¬åœ°å¤„ç†ï¼Œç»ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
      </div>
      <p class="text-gray-500 text-sm mt-1">æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€åŠå…¬æ–‡æ¡£ã€PDFå…¨æ ¼å¼äº’è½¬ï¼Œçº¯å‰ç«¯ç¦»çº¿å¯ç”¨</p>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <!-- ä¾èµ–åº“åŠ è½½çŠ¶æ€é¢æ¿ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="libStatusPanel" class="mb-6 p-4 bg-white rounded-lg shadow border border-gray-200">
      <h3 class="text-md font-medium text-gray-700 mb-2">ğŸ“¦ ä¾èµ–åº“åŠ è½½çŠ¶æ€</h3>
      <div id="libStatusList" class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"></div>
      <p id="libGlobalMessage" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <!-- æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Šï¼ˆéšè—ï¼‰ -->
    <div id="compatWarning" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-sm text-red-800 hidden">
      æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒå…¨éƒ¨åŠŸèƒ½ï¼Œæ¨èä½¿ç”¨æœ€æ–°ç‰ˆ Chrome/Edgeã€‚
    </div>

    <!-- Tabåˆ‡æ¢æ  -->
    <div class="border-b border-gray-200 mb-8">
      <nav class="-mb-px flex space-x-8" id="tabNav">
        <button class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="image" id="tabImage">å›¾ç‰‡è½¬æ¢</button>
        <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="video" id="tabVideo">è§†é¢‘è½¬æ¢</button>
        <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="audio" id="tabAudio">éŸ³é¢‘è½¬æ¢</button>
        <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="document" id="tabDocument">æ–‡æ¡£è½¬æ¢</button>
        <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="pdf" id="tabPdf">PDFå¤„ç†</button>
      </nav>
    </div>

    <!-- å›¾ç‰‡è½¬æ¢Tab (å†…å®¹ä¸ä¹‹å‰ç›¸åŒï¼Œä¸ºèŠ‚çœç¯‡å¹…ä¿ç•™ç»“æ„ï¼Œå®é™…éœ€è¦åŒ…å«å…¨éƒ¨tabå†…å®¹ï¼Œæ­¤å¤„ä»…ç¤ºæ„) -->
    <div class="tab-content" id="imageTab">...ï¼ˆæ­¤å¤„çœç•¥ï¼Œæœ€ç»ˆä»£ç ä¼šåŒ…å«å®Œæ•´å†…å®¹ï¼‰...</div>
    <div class="tab-content hidden" id="videoTab">...</div>
    <div class="tab-content hidden" id="audioTab">...</div>
    <div class="tab-content hidden" id="documentTab">...</div>
    <div class="tab-content hidden" id="pdfTab">...</div>
  </main>

  <!-- åº•éƒ¨ï¼ˆä¸å˜ï¼‰ -->
  <footer class="bg-white border-t border-gray-200 mt-12 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <p class="text-center text-sm text-gray-500 mb-2">çº¯å‰ç«¯æœ¬åœ°è½¬æ¢å·¥å…· | åŸºäºå¼€æºæŠ€æœ¯æ„å»º | æ¨èä½¿ç”¨Chrome/Edgeæœ€æ–°æµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒ</p>
      <p class="text-center text-sm">
        <a href="https://github.com/wqnmlgb151/Online-conversion" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center justify-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          æŸ¥çœ‹é¡¹ç›®æºç  Â· GitHubä»“åº“
        </a>
      </p>
    </div>
  </footer>

  <script>
    // ==================== å…¨å±€é…ç½® ====================
    // å®šä¹‰æ‰€æœ‰éœ€è¦æ£€æµ‹çš„åº“åŠå…¶å¤‡é€‰CDNã€å…¨å±€å˜é‡åã€ä¾èµ–çš„tab
    const LIBRARIES = [
      { name: 'XLSX', varName: 'XLSX', cdn: 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', fallbackCdns: ['https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'], tabs: ['document'] },
      { name: 'mammoth', varName: 'mammoth', cdn: 'https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js', fallbackCdns: ['https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js'], tabs: ['document'] },
      { name: 'marked', varName: 'marked', cdn: 'https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js', fallbackCdns: ['https://unpkg.com/marked@9.1.2/marked.min.js'], tabs: ['document'] },
      { name: 'jsPDF', varName: 'jspdf', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', fallbackCdns: ['https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'], tabs: ['document', 'pdf'] },
      { name: 'html2canvas', varName: 'html2canvas', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', fallbackCdns: ['https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'], tabs: ['document', 'pdf'] },
      { name: 'pdf.js', varName: 'pdfjsLib', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js', fallbackCdns: ['https://unpkg.com/pdfjs-dist@4.0.379/build/pdf.min.js'], tabs: ['pdf'] },
      { name: 'Turndown', varName: 'TurndownService', cdn: 'https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.umd.js', fallbackCdns: ['https://unpkg.com/turndown@7.1.2/dist/turndown.umd.js'], tabs: ['document'] },
      { name: 'JSZip', varName: 'JSZip', cdn: 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', fallbackCdns: ['https://unpkg.com/jszip@3.10.1/dist/jszip.min.js'], tabs: ['pdf'] },
      { name: 'FFmpeg', varName: 'FFmpeg', cdn: 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js', fallbackCdns: ['https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js'], coreCdn: 'https://unpkg.com/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js', coreFallback: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js', tabs: ['video', 'audio'] }
    ];

    // å…¨å±€çŠ¶æ€
    let ffmpeg = null;
    let ffmpegLoaded = false;
    let ffmpegLoading = false;
    let isConverting = false;
    let currentDownloadUrl = null;

    // åº“åŠ è½½çŠ¶æ€è®°å½•
    const libStatus = {};
    LIBRARIES.forEach(lib => { libStatus[lib.name] = { loaded: false, attempted: false, failed: false }; });

    // DOM å…ƒç´ 
    const libStatusListEl = document.getElementById('libStatusList');
    const libGlobalMessage = document.getElementById('libGlobalMessage');
    const compatWarning = document.getElementById('compatWarning');

    // ==================== åŠ¨æ€åŠ è½½ä¸é‡è¯•æœºåˆ¶ ====================
    /** åŠ¨æ€åŠ è½½å•ä¸ªè„šæœ¬ï¼Œè¿”å›Promise */
    function loadScript(src, isModule = false) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        if (isModule) script.type = 'module';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`åŠ è½½å¤±è´¥: ${src}`));
        document.head.appendChild(script);
      });
    }

    /** å°è¯•åŠ è½½ä¸€ä¸ªåº“ï¼ŒåŒ…æ‹¬å¤‡é€‰CDN */
    async function loadLibrary(lib) {
      if (libStatus[lib.name].loaded) return true;
      if (libStatus[lib.name].attempted) return false; // å·²å°è¯•è¿‡ä½†å¤±è´¥

      libStatus[lib.name].attempted = true;
      updateLibStatusUI();

      // å°è¯•ä¸»CDN
      const allCdns = [lib.cdn, ...(lib.fallbackCdns || [])];
      for (const cdn of allCdns) {
        try {
          await loadScript(cdn);
          // æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦å­˜åœ¨
          if (window[lib.varName] !== undefined) {
            libStatus[lib.name].loaded = true;
            updateLibStatusUI();
            // å¦‚æœæ˜¯FFmpegï¼Œè¿˜éœ€è¦é¢å¤–å¤„ç†core
            if (lib.name === 'FFmpeg' && lib.coreCdn) {
              // FFmpeg core ä¼šåœ¨ä½¿ç”¨æ—¶åŠ è½½ï¼Œæ­¤å¤„ä¸é¢„åŠ è½½ï¼Œä½†å¯ä»¥è®¾ç½®é»˜è®¤corePath
              // å·²ç»åœ¨initFFmpegä¸­é…ç½®
            }
            return true;
          } else {
            console.warn(`åº“ ${lib.name} è„šæœ¬åŠ è½½åæœªå®šä¹‰å…¨å±€å˜é‡ ${lib.varName}ï¼Œå°è¯•ä¸‹ä¸€ä¸ªCDN`);
          }
        } catch (e) {
          console.warn(`CDN ${cdn} åŠ è½½å¤±è´¥`, e);
        }
      }

      // æ‰€æœ‰CDNå‡å¤±è´¥
      libStatus[lib.name].failed = true;
      updateLibStatusUI();
      return false;
    }

    /** æ›´æ–°UIä¸­çš„åº“çŠ¶æ€åˆ—è¡¨ */
    function updateLibStatusUI() {
      const html = LIBRARIES.map(lib => {
        const status = libStatus[lib.name];
        let dotClass = 'loading';
        let text = `${lib.name}: åŠ è½½ä¸­...`;
        if (status.loaded) {
          dotClass = 'success';
          text = `${lib.name}: å·²åŠ è½½`;
        } else if (status.failed) {
          dotClass = 'failed';
          text = `${lib.name}: åŠ è½½å¤±è´¥`;
        } else if (status.attempted) {
          dotClass = 'loading';
          text = `${lib.name}: é‡è¯•ä¸­...`;
        } else {
          dotClass = 'loading';
          text = `${lib.name}: ç­‰å¾…åŠ è½½...`;
        }
        return `<div class="lib-status-item"><span class="lib-status-dot ${dotClass}"></span>${text}</div>`;
      }).join('');
      libStatusListEl.innerHTML = html;

      // å…¨å±€æ¶ˆæ¯ï¼šå¦‚æœæœ‰å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
      const failedLibs = LIBRARIES.filter(lib => libStatus[lib.name].failed).map(l => l.name);
      if (failedLibs.length > 0) {
        libGlobalMessage.innerText = `âš ï¸ éƒ¨åˆ†åº“åŠ è½½å¤±è´¥ï¼š${failedLibs.join('ã€')}ï¼Œç›¸å…³åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ã€‚å¯å°è¯•åˆ·æ–°é¡µé¢ã€‚`;
        libGlobalMessage.classList.add('text-red-600');
      } else {
        const allLoaded = LIBRARIES.every(lib => libStatus[lib.name].loaded);
        if (allLoaded) {
          libGlobalMessage.innerText = 'âœ… æ‰€æœ‰ä¾èµ–åº“åŠ è½½æˆåŠŸï¼';
          libGlobalMessage.classList.remove('text-red-600');
          libGlobalMessage.classList.add('text-green-600');
        } else {
          libGlobalMessage.innerText = 'â³ æ­£åœ¨åŠ è½½ä¾èµ–åº“...';
          libGlobalMessage.classList.remove('text-red-600', 'text-green-600');
        }
      }
    }

    /** ç­‰å¾…æŸä¸ªåº“åŠ è½½å®Œæˆï¼ˆé‡è¯•æœºåˆ¶å†…éƒ¨è°ƒç”¨ï¼‰ */
    async function ensureLibrary(libName) {
      const lib = LIBRARIES.find(l => l.name === libName);
      if (!lib) return false;
      if (libStatus[lib.name].loaded) return true;
      if (libStatus[lib.name].failed) return false;

      // å°è¯•åŠ è½½ï¼ˆä¼šè¿›è¡Œé‡è¯•ï¼‰
      return await loadLibrary(lib);
    }

    /** åˆå§‹åŒ–æ‰€æœ‰åº“ï¼ˆä¾æ¬¡å°è¯•åŠ è½½ï¼‰ */
    async function initLibraries() {
      // å…ˆæ›´æ–°UI
      updateLibStatusUI();

      // å¹¶å‘åŠ è½½æ‰€æœ‰åº“ï¼ˆä½†ä¸ºäº†é¿å…è¿‡å¤šå¹¶å‘ï¼Œå¯ä»¥åˆ†æ‰¹ï¼‰
      const promises = LIBRARIES.map(lib => loadLibrary(lib));
      await Promise.allSettled(promises);

      // æ‰€æœ‰åº“å°è¯•å®Œæ¯•åï¼Œæ›´æ–°UIå¹¶å¯ç”¨/ç¦ç”¨å¯¹åº”Tab
      updateLibStatusUI();
      applyLibraryEnablement();
    }

    /** æ ¹æ®åº“åŠ è½½çŠ¶æ€å¯ç”¨/ç¦ç”¨TabæŒ‰é’®å’Œè½¬æ¢æŒ‰é’® */
    function applyLibraryEnablement() {
      // è·å–æ¯ä¸ªtabä¾èµ–çš„åº“æ˜¯å¦å…¨éƒ¨åŠ è½½
      const tabs = ['image', 'video', 'audio', 'document', 'pdf'];
      tabs.forEach(tab => {
        const requiredLibs = LIBRARIES.filter(lib => lib.tabs.includes(tab));
        const allLoaded = requiredLibs.every(lib => libStatus[lib.name].loaded);
        const tabBtn = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        if (tabBtn) {
          tabBtn.disabled = !allLoaded && tab !== 'image'; // å›¾ç‰‡tabä¸ä¾èµ–ä»»ä½•åº“ï¼Œæ°¸è¿œå¯ç”¨
          if (!allLoaded && tab !== 'image') {
            tabBtn.title = `ç¼ºå°‘ä¾èµ–åº“ï¼š${requiredLibs.filter(l => !libStatus[l.name].loaded).map(l => l.name).join('ã€')}`;
          } else {
            tabBtn.title = '';
          }
        }
      });

      // å¦‚æœå½“å‰æ¿€æ´»çš„tabè¢«ç¦ç”¨ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°å›¾ç‰‡tab
      const activeTabBtn = document.querySelector('.tab-btn.border-blue-500');
      if (activeTabBtn && activeTabBtn.disabled) {
        document.querySelector('[data-tab="image"]').click();
      }
    }

    // ==================== å…¼å®¹æ€§æ£€æµ‹ ====================
    function checkCompatibility() {
      let hasWasm = typeof WebAssembly === 'object' && WebAssembly.validate;
      let hasToBlob = typeof HTMLCanvasElement.prototype.toBlob === 'function';
      if (!hasWasm || !hasToBlob) {
        compatWarning.classList.remove('hidden');
        compatWarning.innerHTML = `âš ï¸ æ‚¨çš„æµè§ˆå™¨ç¼ºå°‘å¿…è¦APIï¼ˆ${!hasWasm ? 'WebAssembly' : ''} ${!hasToBlob ? 'canvas.toBlob' : ''}ï¼‰ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·æ›´æ–°è‡³æœ€æ–°ç‰ˆChrome/Edgeã€‚`;
      } else {
        compatWarning.classList.add('hidden');
      }
    }

    // ==================== é¡µé¢åˆå§‹åŒ– ====================
    window.addEventListener('DOMContentLoaded', async () => {
      checkCompatibility();
      // å¼€å§‹åŠ è½½åº“
      await initLibraries();

      // å¦‚æœFFmpegåŠ è½½æˆåŠŸï¼Œé¢„é…ç½®
      if (libStatus['FFmpeg'].loaded) {
        // FFmpeg coreå°†åœ¨ä½¿ç”¨æ—¶åŠ è½½
      }

      // è§¦å‘å›¾ç‰‡tabçš„changeäº‹ä»¶ï¼ˆè´¨é‡æç¤ºï¼‰
      document.getElementById('imageFormat')?.dispatchEvent(new Event('change'));
    });

    // ==================== Tabåˆ‡æ¢é€»è¾‘ ====================
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (btn.disabled) return;
        tabBtns.forEach(b => {
          b.classList.remove('border-blue-500', 'text-blue-600');
          b.classList.add('border-transparent', 'text-gray-500');
        });
        tabContents.forEach(tab => tab.classList.add('hidden'));

        btn.classList.remove('border-transparent', 'text-gray-500');
        btn.classList.add('border-blue-500', 'text-blue-600');
        const tabId = btn.dataset.tab + 'Tab';
        document.getElementById(tabId).classList.remove('hidden');

        // å¦‚æœåˆ‡æ¢åˆ°è§†é¢‘/éŸ³é¢‘ä¸”FFmpegæœªåŠ è½½ï¼Œå°è¯•åŠ è½½ï¼ˆä½†å·²ç»ç”±åº“çŠ¶æ€æ§åˆ¶ï¼‰
        if ((btn.dataset.tab === 'video' || btn.dataset.tab === 'audio') && libStatus['FFmpeg'].loaded && !ffmpegLoaded && !ffmpegLoading) {
          initFFmpeg();
        }
      });
    });

    // ==================== FFmpegåˆå§‹åŒ–ï¼ˆä¸ä¹‹å‰ç›¸åŒï¼Œä½†å¢åŠ å¯¹coreçš„å¤‡é€‰ï¼‰====================
    async function initFFmpeg() {
      if (ffmpegLoaded || ffmpegLoading || !libStatus['FFmpeg'].loaded) return;
      ffmpegLoading = true;
      const statusEl = document.querySelector('.tab-content:not(.hidden) #videoStatus') || 
                       document.querySelector('.tab-content:not(.hidden) #audioStatus') ||
                       document.getElementById('videoStatus');
      statusEl.textContent = 'æ­£åœ¨åŠ è½½FFmpegè½¬æ¢å¼•æ“ï¼ˆçº¦30MBï¼‰ï¼Œè¯·ç¨å€™...';

      const timeoutId = setTimeout(() => {
        if (ffmpegLoading) {
          ffmpegLoading = false;
          statusEl.textContent = 'âš ï¸ åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é‡è¯•';
        }
      }, 30000);

      try {
        // å°è¯•ä¸»coreå’Œå¤‡é€‰
        const corePaths = [
          'https://unpkg.com/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js',
          'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js'
        ];
        let loaded = false;
        for (const corePath of corePaths) {
          try {
            ffmpeg = FFmpeg.createFFmpeg({ log: true, corePath });
            await ffmpeg.load();
            loaded = true;
            break;
          } catch (e) {
            console.warn(`FFmpeg core åŠ è½½å¤±è´¥: ${corePath}`, e);
          }
        }
        if (!loaded) throw new Error('æ‰€æœ‰core CDNå‡å¤±è´¥');
        
        clearTimeout(timeoutId);
        ffmpegLoaded = true;
        statusEl.textContent = 'âœ… è½¬æ¢å¼•æ“åŠ è½½å®Œæˆï¼Œå¯æ­£å¸¸ä½¿ç”¨';
      } catch (err) {
        clearTimeout(timeoutId);
        console.error('FFmpegåŠ è½½å¤±è´¥', err);
        statusEl.textContent = 'âŒ è½¬æ¢å¼•æ“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼Œä½¿ç”¨Chrome/Edgeæœ€æ–°æµè§ˆå™¨';
      } finally {
        ffmpegLoading = false;
      }
    }
  </script>
</body>
</html>