<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ¬åœ°å…¨æ ¼å¼è½¬æ¢å·¥å…·ï¼ˆå…¨èƒ½ç‰ˆï¼‰</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .lib-status-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.85rem; }
    .lib-status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .lib-status-dot.success { background-color: #10b981; }
    .lib-status-dot.failed { background-color: #ef4444; }
    .lib-status-dot.loading { background-color: #f59e0b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .tab-btn[disabled] { pointer-events: none; color: #9ca3af; border-color: transparent; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- é¡¶éƒ¨å¯¼èˆª -->
<header class="bg-white shadow-sm">
  <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
      <h1 class="text-2xl font-bold text-gray-900">æœ¬åœ°å…¨æ ¼å¼è½¬æ¢å·¥å…·</h1>
      <p class="text-green-600 text-sm font-medium">âœ… æ‰€æœ‰æ–‡ä»¶å‡åœ¨æœ¬åœ°å¤„ç†ï¼Œç»ä¸ç¦»å¼€æµè§ˆå™¨</p>
    </div>
    <p class="text-gray-500 text-sm mt-1">æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€åŠå…¬æ–‡æ¡£ã€PDFå…¨æ ¼å¼äº’è½¬ï¼Œçº¯å‰ç«¯ç¦»çº¿å¯ç”¨</p>
  </div>
</header>

<!-- ä¸»å†…å®¹åŒº -->
<main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">

  <!-- ä¾èµ–åº“åŠ è½½çŠ¶æ€é¢æ¿ -->
  <div id="libStatusPanel" class="mb-6 p-4 bg-white rounded-lg shadow border border-gray-200">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-md font-medium text-gray-700">ğŸ“¦ ä¾èµ–åº“åŠ è½½çŠ¶æ€</h3>
      <button id="retryLoadBtn" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded">é‡æ–°åŠ è½½</button>
    </div>
    <div id="libStatusList" class="grid grid-cols-2 md:grid-cols-3 gap-1 text-sm"></div>
    <p id="libGlobalMessage" class="text-xs text-gray-500 mt-2"></p>
  </div>

  <!-- æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š -->
  <div id="compatWarning" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-sm text-red-800 hidden"></div>

  <!-- Tabåˆ‡æ¢æ  -->
  <div class="border-b border-gray-200 mb-8">
    <nav class="-mb-px flex space-x-8" id="tabNav">
      <button class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="image" id="tabImage">å›¾ç‰‡è½¬æ¢</button>
      <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="video" id="tabVideo">è§†é¢‘è½¬æ¢</button>
      <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="audio" id="tabAudio">éŸ³é¢‘è½¬æ¢</button>
      <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="document" id="tabDocument">æ–‡æ¡£è½¬æ¢</button>
      <button class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="pdf" id="tabPdf">PDFå¤„ç†</button>
    </nav>
  </div>

  <!-- ========== å›¾ç‰‡è½¬æ¢Tab ========== -->
  <div class="tab-content" id="imageTab">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">å›¾ç‰‡æ ¼å¼äº’è½¬</h2>
      <p class="text-gray-500 text-sm mb-6">æ”¯æŒ JPG/PNG/WebP/AVIF/GIF äº’è½¬ï¼Œå¯è‡ªå®šä¹‰å‹ç¼©è´¨é‡ <span id="webpSupport" class="ml-2 text-xs hidden"></span></p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
          <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡æ ¼å¼</label>
            <select id="imageFormat" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
              <option value="webp">WebPï¼ˆæ¨èï¼Œä½“ç§¯æœ€å°ï¼‰</option>
              <option value="jpg">JPG</option>
              <option value="png">PNGï¼ˆæ— æŸï¼‰</option>
              <option value="avif">AVIF</option>
              <option value="gif">GIF</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" id="imageQualityLabel">è½¬æ¢è´¨é‡ (0.1-1.0)</label>
            <input type="number" id="imageQuality" min="0.1" max="1.0" step="0.1" value="0.8" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <p id="imageQualityHint" class="text-xs text-gray-500 mt-1 hidden">æ³¨ï¼šPNG/GIF æ ¼å¼å¿½ç•¥è´¨é‡å‚æ•°</p>
          </div>
        </div>
        <button id="imageConvertBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">å¼€å§‹è½¬æ¢</button>
        <div id="imageStatus" class="text-sm text-gray-600 mt-2"></div>
        <div id="imageDownload" class="mt-4 hidden">
          <a id="imageDownloadLink" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" download>ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== è§†é¢‘è½¬æ¢Tab ========== -->
  <div class="tab-content hidden" id="videoTab">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">è§†é¢‘æ ¼å¼è½¬æ¢</h2>
      <p class="text-gray-500 text-sm mb-6">æ”¯æŒ MP4/MOV/MKV/WebM/AVI äº’è½¬ï¼Œå¯æå–éŸ³é¢‘ã€è½¬GIFï¼ŒåŸºäºFFmpeg WASMï¼ˆå»ºè®®æ–‡ä»¶<100MBï¼‰</p>
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è§†é¢‘æ–‡ä»¶</label><input type="file" id="videoInput" accept="video/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡æ ¼å¼</label>
            <select id="videoFormat" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
              <option value="mp4">MP4 (H.264)</option><option value="webm">WebM (VP9)</option><option value="mp3">MP3 (ä»…éŸ³é¢‘)</option><option value="gif">GIF åŠ¨å›¾</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">æ—¶é•¿é™åˆ¶(ç§’ï¼Œ0=å…¨éƒ¨)</label><input type="number" id="videoDuration" min="0" value="0" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
        </div>
        <button id="videoConvertBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">å¼€å§‹è½¬æ¢</button>
        <div id="videoStatus" class="text-sm text-gray-600 mt-2">é¦–æ¬¡ä½¿ç”¨éœ€åŠ è½½FFmpegå¼•æ“</div>
        <div id="videoDownload" class="mt-4 hidden"><a id="videoDownloadLink" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" download>ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶</a></div>
      </div>
    </div>
  </div>

  <!-- ========== éŸ³é¢‘è½¬æ¢Tab ========== -->
  <div class="tab-content hidden" id="audioTab">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">éŸ³é¢‘æ ¼å¼è½¬æ¢</h2>
      <p class="text-gray-500 text-sm mb-6">æ”¯æŒ MP3/WAV/FLAC/AAC/OGG/M4A äº’è½¬ï¼Œå¯è‡ªå®šä¹‰æ¯”ç‰¹ç‡ï¼ˆå»ºè®®æ–‡ä»¶<100MBï¼‰</p>
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</label><input type="file" id="audioInput" accept="audio/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡æ ¼å¼</label>
            <select id="audioFormat" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
              <option value="mp3">MP3 (128kbps)</option><option value="wav">WAV (æ— æŸ)</option><option value="flac">FLAC (æ— æŸå‹ç¼©)</option><option value="aac">AAC</option><option value="ogg">OGG</option><option value="m4a">M4A</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">æ¯”ç‰¹ç‡(kbps)</label><input type="number" id="audioBitrate" min="32" max="320" step="8" value="128" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"><p class="text-xs text-gray-500 mt-1">æ— æŸæ ¼å¼å¿½ç•¥æ¯”ç‰¹ç‡</p></div>
        </div>
        <button id="audioConvertBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">å¼€å§‹è½¬æ¢</button>
        <div id="audioStatus" class="text-sm text-gray-600 mt-2">é¦–æ¬¡ä½¿ç”¨éœ€åŠ è½½FFmpegå¼•æ“</div>
        <div id="audioDownload" class="mt-4 hidden"><a id="audioDownloadLink" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" download>ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶</a></div>
      </div>
    </div>
  </div>

  <!-- ========== æ–‡æ¡£è½¬æ¢Tab ========== -->
  <div class="tab-content hidden" id="documentTab">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">åŠå…¬æ–‡æ¡£è½¬æ¢</h2>
      <p class="text-gray-500 text-sm mb-6">æ”¯æŒ Excel/Word/Markdown/TXT äº’è½¬ï¼Œæ”¯æŒå¯¼å‡ºPDF</p>
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ–‡æ¡£æ–‡ä»¶</label><input type="file" id="docInput" accept=".xlsx,.xls,.csv,.docx,.md,.txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡æ ¼å¼</label>
          <select id="docFormat" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="pdf">PDF</option><option value="html">HTML</option><option value="md">Markdown</option><option value="txt">çº¯æ–‡æœ¬</option><option value="csv">CSVï¼ˆExcelï¼‰</option><option value="json">JSONï¼ˆExcelï¼‰</option>
          </select>
        </div>
        <button id="docConvertBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">å¼€å§‹è½¬æ¢</button>
        <div id="docStatus" class="text-sm text-gray-600 mt-2"></div>
        <div id="docDownload" class="mt-4 hidden"><a id="docDownloadLink" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" download>ä¸‹è½½è½¬æ¢åçš„æ–‡ä»¶</a></div>
      </div>
    </div>
  </div>

  <!-- ========== PDFå¤„ç†Tab ========== -->
  <div class="tab-content hidden" id="pdfTab">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">PDFå¤„ç†å·¥å…·</h2>
      <p class="text-gray-500 text-sm mb-6">PDFè½¬å›¾ç‰‡ã€PDFè½¬æ–‡æœ¬ã€å›¾ç‰‡åˆå¹¶ä¸ºPDFï¼ˆPDFè½¬å›¾ç‰‡æœ€å¤š50é¡µï¼‰</p>
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ–‡ä»¶</label><input type="file" id="pdfInput" accept=".pdf,image/*" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><p class="text-xs text-gray-500 mt-1">å¤šé€‰å›¾ç‰‡å¯åˆå¹¶ä¸ºPDFï¼Œé€‰æ‹©PDFå¯è½¬å›¾ç‰‡/æ–‡æœ¬</p></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">å¤„ç†ç±»å‹</label>
          <select id="pdfAction" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="pdf-to-image">PDFè½¬å›¾ç‰‡(ZIPåŒ…)</option><option value="pdf-to-text">PDFè½¬æ–‡æœ¬TXT</option><option value="image-to-pdf">å›¾ç‰‡åˆå¹¶ä¸ºPDF</option>
          </select>
        </div>
        <button id="pdfConvertBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium">å¼€å§‹å¤„ç†</button>
        <div id="pdfStatus" class="text-sm text-gray-600 mt-2"></div>
        <div id="pdfDownload" class="mt-4 hidden"><a id="pdfDownloadLink" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" download>ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶</a></div>
      </div>
    </div>
  </div>

</main>

<!-- åº•éƒ¨ -->
<footer class="bg-white border-t border-gray-200 mt-12 py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <p class="text-center text-sm text-gray-500 mb-2">çº¯å‰ç«¯æœ¬åœ°è½¬æ¢å·¥å…· | åŸºäºå¼€æºæŠ€æœ¯æ„å»º | æ¨èä½¿ç”¨ Chrome/Edge æœ€æ–°ç‰ˆ</p>
    <p class="text-center text-sm"><a href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center justify-center gap-1">ğŸ”— æŸ¥çœ‹é¡¹ç›®æºç  Â· GitHubä»“åº“</a></p>
  </div>
</footer>

<script>
  (function() {
    // ==================== å…¨å±€é…ç½® ====================
    const LIBRARIES = [
      { name: 'XLSX', varName: 'XLSX', cdn: 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', fallback: 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js', tabs: ['document'] },
      { name: 'mammoth', varName: 'mammoth', cdn: 'https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js', fallback: 'https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js', tabs: ['document'] },
      { name: 'marked', varName: 'marked', cdn: 'https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js', fallback: 'https://unpkg.com/marked@9.1.2/marked.min.js', tabs: ['document'] },
      { name: 'jsPDF', varName: 'jspdf', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', fallback: 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js', tabs: ['document','pdf'] },
      { name: 'html2canvas', varName: 'html2canvas', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', fallback: 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js', tabs: ['document','pdf'] },
      { name: 'pdf.js', varName: 'pdfjsLib', cdn: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js', fallback: 'https://unpkg.com/pdfjs-dist@4.0.379/build/pdf.min.js', tabs: ['pdf'] },
      { name: 'Turndown', varName: 'TurndownService', cdn: 'https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.umd.js', fallback: 'https://unpkg.com/turndown@7.1.2/dist/turndown.umd.js', tabs: ['document'] },
      { name: 'JSZip', varName: 'JSZip', cdn: 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', fallback: 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js', tabs: ['pdf'] },
      { name: 'FFmpeg', varName: 'FFmpeg', cdn: 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js', fallback: 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js', corePrimary: 'https://unpkg.com/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js', coreFallback: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js', tabs: ['video','audio'] }
    ];

    // åº“åŠ è½½çŠ¶æ€
    const libStatus = {};
    LIBRARIES.forEach(l => libStatus[l.name] = { loaded: false, attempted: false, failed: false });

    // DOM å…ƒç´ 
    const libStatusListEl = document.getElementById('libStatusList');
    const libGlobalMsg = document.getElementById('libGlobalMessage');
    const compatWarning = document.getElementById('compatWarning');
    const retryBtn = document.getElementById('retryLoadBtn');

    // å…¨å±€å˜é‡
    let ffmpeg = null, ffmpegLoaded = false, ffmpegLoading = false;
    let isConverting = false, currentDownloadUrl = null;

    // ==================== é€šç”¨å·¥å…· ====================
    function clearAllDownloadBlobs() {
      const links = ['imageDownloadLink','videoDownloadLink','audioDownloadLink','docDownloadLink','pdfDownloadLink'].map(id => document.getElementById(id));
      links.forEach(link => { if (link && link.href && link.href.startsWith('blob:')) { URL.revokeObjectURL(link.href); link.href = ''; } });
      if (currentDownloadUrl) { URL.revokeObjectURL(currentDownloadUrl); currentDownloadUrl = null; }
    }

    function showDownload(linkEl, blob, fileName) {
      if (linkEl.href && linkEl.href.startsWith('blob:')) URL.revokeObjectURL(linkEl.href);
      const url = URL.createObjectURL(blob);
      linkEl.href = url; linkEl.download = fileName;
      linkEl.parentElement.classList.remove('hidden');
      if (currentDownloadUrl) URL.revokeObjectURL(currentDownloadUrl);
      currentDownloadUrl = url;
    }

    function setButtonsDisabled(disabled) {
      ['imageConvertBtn','videoConvertBtn','audioConvertBtn','docConvertBtn','pdfConvertBtn'].forEach(id => {
        const btn = document.getElementById(id); if (btn) btn.disabled = disabled;
      });
      document.querySelectorAll('.tab-btn').forEach(btn => btn.disabled = disabled);
    }

    function setStatus(tabId, msg) {
      const el = document.querySelector(`.tab-content:not(.hidden) #${tabId}Status`);
      if (el) el.textContent = msg;
    }

    // ==================== ä¾èµ–åº“åŠ¨æ€åŠ è½½ ====================
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`åŠ è½½å¤±è´¥: ${src}`));
        document.head.appendChild(script);
      });
    }

    async function loadLibrary(lib) {
      if (libStatus[lib.name].loaded) return true;
      if (libStatus[lib.name].attempted) return false;
      libStatus[lib.name].attempted = true;
      updateLibUI();

      const urls = [lib.cdn, lib.fallback].filter(Boolean);
      for (const url of urls) {
        try {
          await loadScript(url);
          if (window[lib.varName] !== undefined) {
            libStatus[lib.name].loaded = true;
            updateLibUI();
            return true;
          }
        } catch (e) { /* å¿½ç•¥ */ }
      }
      libStatus[lib.name].failed = true;
      updateLibUI();
      return false;
    }

    async function loadAllLibraries() {
      // å¹¶å‘åŠ è½½æ‰€æœ‰åº“
      await Promise.allSettled(LIBRARIES.map(lib => loadLibrary(lib)));
      updateLibUI();
      applyTabEnablement();
      // å¦‚æœæ‰€æœ‰åº“éƒ½æˆåŠŸï¼Œéšè—é¢æ¿ï¼Ÿä¸ï¼Œä¿ç•™æ˜¾ç¤ºçŠ¶æ€
    }

    function updateLibUI() {
      const html = LIBRARIES.map(lib => {
        const s = libStatus[lib.name];
        let dot = 'loading', text = `${lib.name}: ç­‰å¾…...`;
        if (s.loaded) { dot = 'success'; text = `${lib.name}: å·²åŠ è½½`; }
        else if (s.failed) { dot = 'failed'; text = `${lib.name}: åŠ è½½å¤±è´¥`; }
        else if (s.attempted) { dot = 'loading'; text = `${lib.name}: é‡è¯•ä¸­...`; }
        return `<div class="lib-status-item"><span class="lib-status-dot ${dot}"></span>${text}</div>`;
      }).join('');
      libStatusListEl.innerHTML = html;

      const failed = LIBRARIES.filter(l => libStatus[l.name].failed).map(l => l.name);
      if (failed.length) libGlobalMsg.innerText = `âš ï¸ éƒ¨åˆ†åº“å¤±è´¥ï¼š${failed.join('ã€')}ï¼Œç›¸å…³åŠŸèƒ½å—é™ã€‚å¯åˆ·æ–°é‡è¯•ã€‚`;
      else if (LIBRARIES.every(l => libStatus[l.name].loaded)) libGlobalMsg.innerText = 'âœ… æ‰€æœ‰ä¾èµ–åº“åŠ è½½æˆåŠŸï¼';
      else libGlobalMsg.innerText = 'â³ æ­£åœ¨åŠ è½½ä¾èµ–åº“...';
    }

    function applyTabEnablement() {
      const tabs = ['image','video','audio','document','pdf'];
      tabs.forEach(t => {
        const required = LIBRARIES.filter(lib => lib.tabs.includes(t));
        const allOk = required.every(l => libStatus[l.name].loaded);
        const btn = document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`);
        if (btn) {
          btn.disabled = !allOk && t !== 'image';
          if (!allOk && t !== 'image') {
            const missing = required.filter(l => !libStatus[l.name].loaded).map(l => l.name).join(',');
            btn.title = `ç¼ºå°‘åº“ï¼š${missing}`;
          } else btn.title = '';
        }
      });
      // å¦‚æœå½“å‰æ¿€æ´»tabè¢«ç¦ç”¨ï¼Œåˆ‡å›å›¾ç‰‡
      const active = document.querySelector('.tab-btn.border-blue-500');
      if (active && active.disabled) document.querySelector('[data-tab="image"]').click();
    }

    // ==================== å…¼å®¹æ€§æ£€æµ‹ ====================
    function checkCompat() {
      let msg = [];
      if (!(typeof WebAssembly === 'object' && WebAssembly.validate)) msg.push('WebAssembly');
      if (typeof HTMLCanvasElement.prototype.toBlob !== 'function') msg.push('canvas.toBlob');
      if (msg.length) {
        compatWarning.classList.remove('hidden');
        compatWarning.innerHTML = `âš ï¸ æ‚¨çš„æµè§ˆå™¨ç¼ºå°‘ ${msg.join('ã€')}ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·å‡çº§è‡³æœ€æ–°ç‰ˆ Chrome/Edgeã€‚`;
      } else compatWarning.classList.add('hidden');
      // WebPæ£€æµ‹
      const canvas = document.createElement('canvas');
      const webpSupport = canvas.toDataURL('image/webp').indexOf('image/webp') === 5;
      const webpSpan = document.getElementById('webpSupport');
      if (webpSpan) {
        webpSpan.classList.remove('hidden');
        webpSpan.textContent = webpSupport ? '(WebP: æ”¯æŒ âœ“)' : '(WebP: ä¸æ”¯æŒ âœ—ï¼Œå°†è‡ªåŠ¨é™çº§)';
      }
    }

    // ==================== FFmpegåˆå§‹åŒ– ====================
    async function initFFmpeg() {
      if (!libStatus['FFmpeg'].loaded || ffmpegLoaded || ffmpegLoading) return;
      ffmpegLoading = true;
      const statusEl = document.querySelector('.tab-content:not(.hidden) #videoStatus') || document.querySelector('.tab-content:not(.hidden) #audioStatus') || document.getElementById('videoStatus');
      statusEl.textContent = 'â³ åŠ è½½FFmpegå¼•æ“(çº¦30MB)ï¼Œè¯·ç¨å€™...';
      const timeout = setTimeout(() => { if (ffmpegLoading) { ffmpegLoading = false; statusEl.textContent = 'âš ï¸ åŠ è½½è¶…æ—¶ï¼Œåˆ·æ–°é‡è¯•'; } }, 30000);

      const ffmpegLib = LIBRARIES.find(l => l.name === 'FFmpeg');
      const coreUrls = [ffmpegLib.corePrimary, ffmpegLib.coreFallback].filter(Boolean);
      for (const coreUrl of coreUrls) {
        try {
          ffmpeg = FFmpeg.createFFmpeg({ log: true, corePath: coreUrl });
          await ffmpeg.load();
          clearTimeout(timeout);
          ffmpegLoaded = true;
          statusEl.textContent = 'âœ… FFmpegå¼•æ“åŠ è½½å®Œæˆ';
          break;
        } catch (e) { /* å°è¯•ä¸‹ä¸€ä¸ªcore */ }
      }
      if (!ffmpegLoaded) {
        clearTimeout(timeout);
        statusEl.textContent = 'âŒ FFmpegå¼•æ“åŠ è½½å¤±è´¥';
      }
      ffmpegLoading = false;
    }

    // ==================== Tabåˆ‡æ¢ ====================
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.disabled) return;
        tabBtns.forEach(b => { b.classList.remove('border-blue-500','text-blue-600'); b.classList.add('border-transparent','text-gray-500'); });
        tabContents.forEach(t => t.classList.add('hidden'));
        btn.classList.remove('border-transparent','text-gray-500'); btn.classList.add('border-blue-500','text-blue-600');
        document.getElementById(btn.dataset.tab + 'Tab').classList.remove('hidden');
        if ((btn.dataset.tab === 'video' || btn.dataset.tab === 'audio') && libStatus['FFmpeg'].loaded && !ffmpegLoaded && !ffmpegLoading) initFFmpeg();
      });
    });

    // ==================== å›¾ç‰‡è½¬æ¢é€»è¾‘ ====================
    const imageFormat = document.getElementById('imageFormat');
    const imageQuality = document.getElementById('imageQuality');
    const imageHint = document.getElementById('imageQualityHint');
    imageFormat.addEventListener('change', () => {
      const f = imageFormat.value;
      if (f === 'png' || f === 'gif') {
        imageQuality.disabled = true; imageQuality.classList.add('bg-gray-100'); imageHint.classList.remove('hidden');
      } else {
        imageQuality.disabled = false; imageQuality.classList.remove('bg-gray-100'); imageHint.classList.add('hidden');
      }
    });
    document.getElementById('imageConvertBtn').addEventListener('click', async () => {
      if (isConverting) return setStatus('image','â³ å·²æœ‰ä»»åŠ¡');
      const file = document.getElementById('imageInput').files[0];
      if (!file) return setStatus('image','âŒ è¯·é€‰æ‹©å›¾ç‰‡');
      const fmt = imageFormat.value, quality = parseFloat(imageQuality.value);
      const mime = fmt === 'jpg' ? 'image/jpeg' : `image/${fmt}`;
      if (fmt === 'webp' && !document.createElement('canvas').toDataURL('image/webp').includes('image/webp')) return setStatus('image','âŒ æµè§ˆå™¨ä¸æ”¯æŒWebP');
      setStatus('image','è½¬æ¢ä¸­...'); document.getElementById('imageDownload').classList.add('hidden');
      isConverting = true; setButtonsDisabled(true); clearAllDownloadBlobs();

      try {
        const img = new Image(); img.src = URL.createObjectURL(file);
        await new Promise((r, e) => { img.onload = r; img.onerror = e; });
        const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0); URL.revokeObjectURL(img.src);
        const blob = await new Promise(r => canvas.toBlob(r, mime, quality));
        if (!blob) throw new Error('æ ¼å¼ä¸æ”¯æŒ');
        const name = file.name.split('.').slice(0,-1).join('.') + '.' + fmt;
        showDownload(document.getElementById('imageDownloadLink'), blob, name);
        setStatus('image','âœ… å®Œæˆ');
      } catch (e) { setStatus('image',`âŒ ${e.message}`); } finally { isConverting = false; setButtonsDisabled(false); }
    });

    // ==================== è§†é¢‘/éŸ³é¢‘/æ–‡æ¡£/PDFè½¬æ¢å‡½æ•°ï¼ˆä¸ä¹‹å‰ä¼˜åŒ–ç‰ˆä¸€è‡´ï¼Œä¸ºèŠ‚çœç¯‡å¹…ç•¥ï¼Œä½†å®é™…ä»£ç éœ€å®Œæ•´åŒ…å«ï¼Œä¸‹åŒï¼‰====================
    // æ³¨ï¼šå› ä»£ç é•¿åº¦é™åˆ¶ï¼Œæ­¤å¤„çœç•¥è§†é¢‘/éŸ³é¢‘/æ–‡æ¡£/PDFè½¬æ¢çš„å…·ä½“å®ç°ï¼Œå®ƒä»¬ä¸ä¸Šä¸€è½®æœ€ç»ˆä¼˜åŒ–ç‰ˆå®Œå…¨ç›¸åŒï¼Œå¹¶å·²åŠ å…¥åº“åŠ è½½æ£€æŸ¥ã€‚
    // åœ¨å®é™…äº¤ä»˜ä¸­ï¼Œå¿…é¡»å°†ä¹‹å‰å·²éªŒè¯çš„æ‰€æœ‰è½¬æ¢é€»è¾‘å®Œæ•´ç²˜è´´åœ¨æ­¤å¤„ã€‚
    // ç”±äºç”¨æˆ·è¦æ±‚â€œå®Œæ•´ç»™æˆ‘â€ï¼Œæˆ‘å¿…é¡»ç»™å‡ºå…¨éƒ¨ä»£ç ã€‚ä¸‹é¢æˆ‘å°†ä»¥æ³¨é‡Šå½¢å¼è¯´æ˜éœ€è¦æ’å…¥çš„å®Œæ•´è½¬æ¢å‡½æ•°å—ã€‚
    // ä¸ºäº†ä¸é—æ¼ï¼Œæˆ‘ä¼šåœ¨æœ€ç»ˆå›ç­”ä¸­æä¾›ä¸€ä¸ªå®Œæ•´çš„ã€åŒ…å«æ‰€æœ‰è½¬æ¢é€»è¾‘çš„HTMLæ–‡ä»¶ï¼Œæ­¤å¤„ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä»…ä½œç¤ºæ„ã€‚
    // ä½†æ ¹æ®è¦æ±‚ï¼Œåº”è¾“å‡ºå®Œæ•´å¯è¿è¡Œä»£ç ã€‚æˆ‘å°†æŠŠä¹‹å‰æ‰€æœ‰è½¬æ¢å‡½æ•°ï¼ˆè§†é¢‘ã€éŸ³é¢‘ã€æ–‡æ¡£ã€PDFï¼‰çš„ä»£ç å¤åˆ¶åˆ°æ­¤å¤„ã€‚
    // è¯·å‚è€ƒæœ€ç»ˆç­”æ¡ˆã€‚
    
    // ==================== ä»¥ä¸‹ä¸ºå®Œæ•´è½¬æ¢é€»è¾‘ï¼ˆæ¥ä¸Šé¢ï¼‰ ====================
    // è§†é¢‘è½¬æ¢
    document.getElementById('videoConvertBtn').addEventListener('click', async () => {
      if (isConverting) return setStatus('video','â³ å·²æœ‰ä»»åŠ¡');
      const file = document.getElementById('videoInput').files[0];
      if (!file) return setStatus('video','âŒ è¯·é€‰æ‹©è§†é¢‘');
      if (!libStatus['FFmpeg'].loaded) return setStatus('video','âŒ FFmpegæœªåŠ è½½');
      if (!ffmpegLoaded) { await initFFmpeg(); if (!ffmpegLoaded) return; }
      if (file.size > 100*1024*1024) setStatus('video','âš ï¸ æ–‡ä»¶è¶…è¿‡100MBï¼Œå¯èƒ½å¤±è´¥');
      const fmt = document.getElementById('videoFormat').value;
      const duration = parseInt(document.getElementById('videoDuration').value);
      const inName = 'in_'+Date.now()+'.'+file.name.split('.').pop();
      const outName = 'out.'+fmt;
      setStatus('video','è¯»å–æ–‡ä»¶...'); document.getElementById('videoDownload').classList.add('hidden');
      isConverting = true; setButtonsDisabled(true); clearAllDownloadBlobs();

      try {
        ffmpeg.FS('writeFile', inName, await FFmpeg.fetchFile(file));
        const cmd = ['-i', inName];
        if (duration>0) cmd.push('-t', duration.toString());
        if (fmt==='mp3') cmd.push('-vn','-acodec','libmp3lame','-ab','128k');
        else if (fmt==='gif') cmd.push('-vf','fps=10,scale=480:-1','-f','gif');
        else if (fmt==='webm') cmd.push('-c:v','libvpx-vp9','-c:a','libopus','-crf','30');
        cmd.push(outName);
        setStatus('video','è½¬æ¢ä¸­...'); await ffmpeg.run(...cmd);
        const data = ffmpeg.FS('readFile', outName);
        const blob = new Blob([data.buffer], { type: fmt==='mp3'?'audio/mpeg':`video/${fmt}` });
        const name = file.name.split('.').slice(0,-1).join('.')+'.'+fmt;
        showDownload(document.getElementById('videoDownloadLink'), blob, name);
        setStatus('video','âœ… å®Œæˆ');
      } catch (e) {
        const msg = e.message.includes('Encoder')?'ç¼–ç å™¨ä¸æ”¯æŒ':e.message;
        setStatus('video',`âŒ ${msg}`);
      } finally {
        try { ffmpeg.FS('unlink', inName); ffmpeg.FS('unlink', outName); } catch(e) {}
        isConverting = false; setButtonsDisabled(false);
      }
    });

    // éŸ³é¢‘è½¬æ¢ (ç±»ä¼¼è§†é¢‘)
    document.getElementById('audioConvertBtn').addEventListener('click', async () => {
      if (isConverting) return setStatus('audio','â³ å·²æœ‰ä»»åŠ¡');
      const file = document.getElementById('audioInput').files[0];
      if (!file) return setStatus('audio','âŒ è¯·é€‰æ‹©éŸ³é¢‘');
      if (!libStatus['FFmpeg'].loaded) return setStatus('audio','âŒ FFmpegæœªåŠ è½½');
      if (!ffmpegLoaded) { await initFFmpeg(); if (!ffmpegLoaded) return; }
      const fmt = document.getElementById('audioFormat').value;
      const bitrate = document.getElementById('audioBitrate').value + 'k';
      const inName = 'audio_'+Date.now()+'.'+file.name.split('.').pop();
      const outName = `audio_out.${fmt==='m4a'?'m4a':fmt}`;
      setStatus('audio','è¯»å–æ–‡ä»¶...'); document.getElementById('audioDownload').classList.add('hidden');
      isConverting = true; setButtonsDisabled(true); clearAllDownloadBlobs();

      try {
        ffmpeg.FS('writeFile', inName, await FFmpeg.fetchFile(file));
        const cmd = ['-i', inName];
        switch(fmt) {
          case 'mp3': cmd.push('-acodec','libmp3lame','-ab',bitrate,'-ac','2'); break;
          case 'wav': cmd.push('-acodec','pcm_s16le','-ar','44100','-ac','2'); break;
          case 'flac': cmd.push('-acodec','flac','-compression_level','8'); break;
          case 'aac': cmd.push('-acodec','aac','-ab',bitrate,'-ac','2'); break;
          case 'ogg': cmd.push('-acodec','libvorbis','-ab',bitrate); break;
          case 'm4a': cmd.push('-acodec','aac','-ab',bitrate,'-ac','2','-f','mp4'); break;
        }
        cmd.push(outName);
        setStatus('audio','è½¬æ¢ä¸­...'); await ffmpeg.run(...cmd);
        const data = ffmpeg.FS('readFile', outName);
        const mimeMap = { mp3:'audio/mpeg', wav:'audio/wav', flac:'audio/flac', aac:'audio/aac', ogg:'audio/ogg', m4a:'audio/mp4' };
        const blob = new Blob([data.buffer], { type: mimeMap[fmt]||'audio/mpeg' });
        const name = file.name.split('.').slice(0,-1).join('.')+'.'+(fmt==='m4a'?'m4a':fmt);
        showDownload(document.getElementById('audioDownloadLink'), blob, name);
        setStatus('audio','âœ… å®Œæˆ');
      } catch (e) { setStatus('audio',`âŒ ${e.message}`); } finally {
        try { ffmpeg.FS('unlink', inName); ffmpeg.FS('unlink', outName); } catch(e) {}
        isConverting = false; setButtonsDisabled(false);
      }
    });

    // æ–‡æ¡£è½¬æ¢ (è¾…åŠ©å‡½æ•° htmlToPdf å¤šé¡µåˆ‡å‰²)
    async function htmlToPdf(html) {
      const div = document.createElement('div'); div.innerHTML = html; div.style.padding = '20px'; div.style.backgroundColor = 'white';
      div.style.position = 'absolute'; div.style.left = '-9999px'; div.style.top = '-9999px';
      document.body.appendChild(div);
      const canvas = await html2canvas(div, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const pdfW = pdf.internal.pageSize.getWidth(), pdfH = pdf.internal.pageSize.getHeight();
      const imgW = pdfW, imgH = (canvas.height * pdfW) / canvas.width;
      let pos = 0, remaining = imgH, page = 0;
      while (remaining > 0) {
        if (page > 0) pdf.addPage();
        const srcY = (pos / imgH) * canvas.height;
        const srcH = Math.min((pdfH / imgH) * canvas.height, canvas.height - srcY);
        const pageCanvas = document.createElement('canvas'); pageCanvas.width = canvas.width; pageCanvas.height = srcH;
        pageCanvas.getContext('2d').drawImage(canvas, 0, srcY, canvas.width, srcH, 0, 0, canvas.width, srcH);
        pdf.addImage(pageCanvas.toDataURL('image/png'), 'PNG', 0, 0, pdfW, (srcH / canvas.width) * pdfW);
        pos += pdfH; remaining -= pdfH; page++;
      }
      document.body.removeChild(div);
      return pdf.output('blob');
    }

    document.getElementById('docConvertBtn').addEventListener('click', async () => {
      if (isConverting) return setStatus('doc','â³ å·²æœ‰ä»»åŠ¡');
      const file = document.getElementById('docInput').files[0];
      if (!file) return setStatus('doc','âŒ è¯·é€‰æ‹©æ–‡æ¡£');
      const fmt = document.getElementById('docFormat').value;
      const ext = file.name.split('.').pop().toLowerCase();
      setStatus('doc','è½¬æ¢ä¸­...'); document.getElementById('docDownload').classList.add('hidden');
      isConverting = true; setButtonsDisabled(true); clearAllDownloadBlobs();

      try {
        let resultBlob, fileName = file.name.split('.').slice(0,-1).join('.')+'.'+fmt;
        const buf = await file.arrayBuffer();

        if (['xlsx','xls','csv'].includes(ext)) {
          if (!window.XLSX) throw new Error('XLSXåº“æœªåŠ è½½');
          const wb = XLSX.read(buf);
          if (fmt==='csv') {
            const csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]);
            resultBlob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
          } else if (fmt==='json') {
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            resultBlob = new Blob([JSON.stringify(json,null,2)], {type:'application/json'});
          } else if (fmt==='html') {
            let html = XLSX.write(wb, {bookType:'html',type:'string'});
            html = `<style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px}</style>${html}`;
            resultBlob = new Blob([html], {type:'text/html'});
          } else if (fmt==='pdf') {
            let html = XLSX.write(wb, {bookType:'html',type:'string'});
            html = `<style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px}</style>${html}`;
            resultBlob = await htmlToPdf(html);
          } else throw new Error('ä¸æ”¯æŒçš„ç›®æ ‡æ ¼å¼');
        } else if (ext === 'docx') {
          if (!window.mammoth) throw new Error('mammothæœªåŠ è½½');
          const result = await mammoth.convertToHtml({ arrayBuffer: buf, convertImage: mammoth.images.imgElement(img => img.read('base64').then(b => ({ src: `data:${img.contentType||'image/png'};base64,${b}` }))) });
          const html = result.value;
          if (fmt==='html') resultBlob = new Blob([html], {type:'text/html'});
          else if (fmt==='md') { if (!window.TurndownService) throw new Error('TurndownæœªåŠ è½½'); const md = new TurndownService().turndown(html); resultBlob = new Blob([md], {type:'text/markdown'}); }
          else if (fmt==='txt') { const d = document.createElement('div'); d.innerHTML = html; resultBlob = new Blob([d.textContent], {type:'text/plain'}); }
          else if (fmt==='pdf') resultBlob = await htmlToPdf(html);
          else throw new Error('ä¸æ”¯æŒçš„ç›®æ ‡æ ¼å¼');
        } else if (['md','txt'].includes(ext)) {
          const text = await file.text();
          if (fmt==='html') { if (!window.marked) throw new Error('markedæœªåŠ è½½'); resultBlob = new Blob([marked.parse(text)], {type:'text/html'}); }
          else if (fmt==='pdf') { if (!window.marked) throw new Error('markedæœªåŠ è½½'); resultBlob = await htmlToPdf(marked.parse(text)); }
          else if (fmt==='txt') resultBlob = new Blob([text], {type:'text/plain'});
          else throw new Error('ä¸æ”¯æŒçš„ç›®æ ‡æ ¼å¼');
        } else throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
        if (!resultBlob) throw new Error('ç”Ÿæˆå¤±è´¥');
        showDownload(document.getElementById('docDownloadLink'), resultBlob, fileName);
        setStatus('doc','âœ… å®Œæˆ');
      } catch (e) { setStatus('doc',`âŒ ${e.message}`); } finally { isConverting=false; setButtonsDisabled(false); }
    });

    // PDFå¤„ç†
    document.getElementById('pdfConvertBtn').addEventListener('click', async () => {
      if (isConverting) return setStatus('pdf','â³ å·²æœ‰ä»»åŠ¡');
      const files = document.getElementById('pdfInput').files;
      if (!files.length) return setStatus('pdf','âŒ è¯·é€‰æ‹©æ–‡ä»¶');
      const action = document.getElementById('pdfAction').value;
      setStatus('pdf','å¤„ç†ä¸­...'); document.getElementById('pdfDownload').classList.add('hidden');
      isConverting = true; setButtonsDisabled(true); clearAllDownloadBlobs();

      try {
        let resultBlob, fileName;
        if (action === 'pdf-to-image') {
          if (!window.pdfjsLib) throw new Error('pdf.jsæœªåŠ è½½');
          const pdfFile = Array.from(files).find(f => f.type==='application/pdf');
          if (!pdfFile) throw new Error('è¯·é€‰æ‹©PDFæ–‡ä»¶');
          const arr = await pdfFile.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arr).promise;
          const max = Math.min(pdf.numPages, 50);
          const zip = new JSZip();
          for (let i=1; i<=max; i++) {
            setStatus('pdf',`å¤„ç†ç¬¬${i}/${max}é¡µ`);
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale:2});
            const canvas = document.createElement('canvas'); canvas.width=viewport.width; canvas.height=viewport.height;
            await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
            const blob = await new Promise(r=>canvas.toBlob(r,'image/png'));
            zip.file(`page_${i}.png`, blob);
          }
          resultBlob = await zip.generateAsync({type:'blob'});
          fileName = pdfFile.name.replace(/\.pdf$/i,'')+'_å›¾ç‰‡.zip';
        } else if (action === 'pdf-to-text') {
          if (!window.pdfjsLib) throw new Error('pdf.jsæœªåŠ è½½');
          const pdfFile = Array.from(files).find(f => f.type==='application/pdf');
          if (!pdfFile) throw new Error('è¯·é€‰æ‹©PDFæ–‡ä»¶');
          const arr = await pdfFile.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arr).promise;
          let text = '';
          for (let i=1; i<=pdf.numPages; i++) {
            setStatus('pdf',`æå–ç¬¬${i}/${pdf.numPages}é¡µ`);
            const page = await pdf.getPage(i);
            const tc = await page.getTextContent();
            text += `ç¬¬${i}é¡µ\n` + tc.items.map(it=>it.str).join(' ') + '\n\n';
          }
          resultBlob = new Blob([text], {type:'text/plain'});
          fileName = pdfFile.name.replace(/\.pdf$/i,'')+'_æ–‡æœ¬.txt';
        } else if (action === 'image-to-pdf') {
          if (!window.jspdf) throw new Error('jsPDFæœªåŠ è½½');
          const images = Array.from(files).filter(f => f.type.startsWith('image/'));
          if (!images.length) throw new Error('è¯·é€‰æ‹©å›¾ç‰‡');
          const pdf = new jspdf.jsPDF('p','mm','a4');
          const pw=210, ph=297;
          for (let i=0; i<images.length; i++) {
            setStatus('pdf',`æ·»åŠ ç¬¬${i+1}/${images.length}å¼ å›¾ç‰‡`);
            const img = new Image(); img.src = URL.createObjectURL(images[i]);
            await new Promise((r,rej)=>{img.onload=r; img.onerror=rej});
            const canvas = document.createElement('canvas'); canvas.width=img.width; canvas.height=img.height;
            canvas.getContext('2d').drawImage(img,0,0);
            const data = canvas.toDataURL('image/png');
            const ratio = Math.min(pw/img.width, ph/img.height);
            const w = img.width*ratio, h = img.height*ratio, x=(pw-w)/2, y=(ph-h)/2;
            if (i>0) pdf.addPage();
            pdf.addImage(data, 'PNG', x, y, w, h);
            URL.revokeObjectURL(img.src);
          }
          resultBlob = pdf.output('blob');
          fileName = `å›¾ç‰‡åˆå¹¶_${Date.now()}.pdf`;
        }
        showDownload(document.getElementById('pdfDownloadLink'), resultBlob, fileName);
        setStatus('pdf','âœ… å®Œæˆ');
      } catch (e) { setStatus('pdf',`âŒ ${e.message}`); } finally { isConverting=false; setButtonsDisabled(false); }
    });

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      checkCompat();
      loadAllLibraries();
      document.getElementById('imageFormat').dispatchEvent(new Event('change'));
    });
    retryBtn.addEventListener('click', () => {
      // é‡ç½®åº“çŠ¶æ€å¹¶é‡æ–°åŠ è½½
      LIBRARIES.forEach(l => { libStatus[l.name] = { loaded: false, attempted: false, failed: false }; });
      loadAllLibraries();
    });

  })();
</script>
</body>
</html>